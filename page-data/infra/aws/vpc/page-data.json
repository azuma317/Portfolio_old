{"componentChunkName":"component---src-templates-blog-post-template-tsx","path":"/infra/aws/vpc/","result":{"data":{"site":{"siteMetadata":{"title":"Azuma Blog"}},"markdownRemark":{"id":"618de091-0fc5-544c-a30c-1ac8b54d754e","excerpt":"概要 VPC: Amazon Virtual Private Cloud プライベートなネットワークを AWS 内に作成できる。 インターネットゲートウェイ( IGW ) で、インターネットに接続できる。 仮想プライベートゲートウェイ( VGW ) で、Direct Connect や VPN…","html":"<h2>概要</h2>\n<p>VPC: Amazon Virtual Private Cloud</p>\n<p>プライベートなネットワークを AWS 内に作成できる。</p>\n<p>インターネットゲートウェイ( IGW ) で、インターネットに接続できる。</p>\n<p>仮想プライベートゲートウェイ( VGW ) で、Direct Connect や VPN 経由でインターネットに出ることなく各拠点のネットワークに接続することが可能。</p>\n<p>ネットワーク空間を構築する際は、可能な限り大きなサイズ(/16)で作成したほうが良い。</p>\n<p>確保した空間が小さく、IP アドレスが不足した場合、あとから拡張するのは困難。</p>\n<h2>IP アドレス（CIDR ブロック）</h2>\n<p>IP アドレスは、クラス A(10.0.0.0~10.255.255.255), クラス B(172.16.0.0~172.31.255.255), クラス C(192.168.0.0~192.168.255.255)が使える。</p>\n<p>ただし、クラス A でも /8 で CIDR ブロックを取ることができず、/16 でなければならない。</p>\n<h2>サブネット</h2>\n<p>サブネットは、VPC 内部に作るアドレスレンジである。</p>\n<p>VPC では、/16 ~/28 まで設定できる。（IP アドレス数は 16~65536 個）</p>\n<p>サブネット作成時にアベイラビリティゾーンを指定するが、作成後は変更できない。</p>\n<p>サブネットごとにルートテーブルとネットワーク ACL を 1 つだけ指定する。</p>\n<p>1 つの VPC で作れるサブネット数は 200 個。(リクエストすることで拡張できる)</p>\n<p>サブネットの最初の 4 つと最後の 1 つのアドレスは予約されていて使用できない。(24 ビットマスクのサブネットだと使えないのは「0,1,2,3,255」の 5 つ)</p>\n<p>必要以上にサブネットで分けるとアドレスの消費につながる。(28 ビットマスクで 16 個の IP が割り振られるが、実際は 11 個しか使えない)</p>\n<p>サービスの中には IP アドレスの確保が必要な物がある。(ELB の場合は IP アドレスが 8 個)</p>\n<h2>マルチ AZ</h2>\n<p>サブネット作成時は、同一の役割を持ったサブネットを複数の AZ に作成する。</p>\n<p>これをマルチ AZ と呼ばれる。</p>\n<p>インターネットゲートウェイ・ルートテーブル・ネットワーク ACL などを利用して、パブリックサブネットやプライベートサブネットといった役割を持つことができる。</p>\n<h2>ルートテーブル</h2>\n<p>ルーティング設計によって、VPC 内部の通信や外部への通信を実装できる。</p>\n<p>個々のサブネットに 1 つずつ設定する。</p>\n<p>1 つのルートテーブルを複数のサブネットで共有できるが、1 つのサブネットに複数のルートテーブルを適用することはできない。</p>\n<p>宛先アドレスとターゲットになるゲートウェイ(ネクストホップ)を指定する。</p>\n<p>VPC にメインルートテーブルがあり、サブネット作成時に指定しない場合は VPC のルートテーブルになる。</p>\n<h2>セキュリティグループ</h2>\n<p>VPC の通信制御はセキュリティグループとネットワーク ACL(NACL)を利用して行う。</p>\n<p>セキュリティグループは、EC2 や ELB、RDS など、インスタンス単位の通信制御に利用する。</p>\n<p>インスタンスには少なくとも 1 つのセキュリティグループをアタッチする必要がある。</p>\n<p>通信制御としてはインバウンド(外部から VPC へ)とアウトバウンド(内部から外部へ)の両方の制御が可能である。</p>\n<p>制御項目としては、プロトコル(TCP や UDP など)とポート範囲、送受信先の CIDR もしくはセキュリティグループを指定できる。</p>\n<p>セキュリティグループはデフォルトでアクセスを拒否し、設定された項目のみアクセスを許可する。</p>\n<h2>ネットワーク ACL</h2>\n<p>ネットワーク ACL(アクセスコントロールリスト)は、サブネットごとの通信制御に利用します。</p>\n<p>通信制御としては、セキュリティグループと同じくインバウンととアウトバウンドの制御が可能である。</p>\n<p>送受信先の CIDR とポートを指定できますが、セキュリティグループでの指定はできない。</p>\n<p>ネットワーク ACL はデフォルトですべての通信を許可する。</p>\n<p>セキュリティグループとネットワーク CL の違いは、状態(ステート)を保持するかどうかである。</p>\n<h2>ゲートウェイ</h2>\n<p>ゲートウェイは、VPC の内部と外部との通信をやり取りする出入り口である。</p>\n<p>インターネットゲートウェイ(IGW)は、VPC とインターネットとを接続するためのゲートウェイである。</p>\n<p>各 VPC に 1 つだけアタッチすることができる。</p>\n<p>インターネットゲートウェイ自体に設定事項はなく、論理的に 1 つしか見えないため、可用性の観点で単一障害点になる懸念があるが、AWS によるマネージドなサービスであるため、冗長化や障害児の復旧が自動的になされている。</p>\n<p>ルートテーブルでインターネットゲートウェイをターゲットに指定すると、その宛先アドレスとの通信はインターネットゲートウェイを通してインターネットに向けられる。</p>\n<p>多くの場合、デフォルトルート「0.0.0.0/0」を指定することになる。</p>\n<p>パブリックサブネットの条件の 1 つは、ルーティングでインターネットゲートウェイを向いていることがある。</p>\n<p>逆に言うと、プライベートサブネットはルーティングが直接インターネットゲートウェイに向いていないネットワークになる。</p>\n<p>EC2 インスタンスがインターネットと通信するには、パブリック IP を持っていなければならない。</p>\n<p>あるいは、NAT ゲートウェイを経由してインターネットと通信する。</p>\n<p>NAT ゲートウェイはネットワークアドレス変換機能を有し、プライベート IP を NAT ゲートウェイが持つグローバル IP に変換し、外部と通信する。</p>\n<h2>VPC エンドポイント</h2>\n<p>VPC ないからインターネット上の AWS サービスに接続する方法としては、インターネットゲートウェイを利用する方法と、VPC エンドポイントと呼ばれる特殊なゲートウェイを利用する方法がある。</p>\n<p>VPC エンドポイントには、S3 や DynamoDB と接続する際に利用するゲートウェイエンドポイントと、それ以外の大多数のサービスで利用するインターフェイスエンドポイント(AWS PrivateLink)がある。</p>\n<p>エンドポイントを作成しサブネットと関連付けると、そのサブネットから S3、DynamoDB への通信はインターネットゲートウェイではなくエンドポイントを通じて行われます。</p>","frontmatter":{"title":"VPCのまとめ","date":"September 25, 2020","description":"VPCについてまとめてみました。"}}},"pageContext":{"slug":"/infra/aws/vpc/"}},"staticQueryHashes":["1096143047","2841359383","3868140423"]}