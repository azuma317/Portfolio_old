{"componentChunkName":"component---src-templates-blog-post-template-tsx","path":"/blog/infra/vpc/","result":{"data":{"site":{"siteMetadata":{"title":"Azuma Blog"}},"markdownRemark":{"id":"c66c95b5-f33e-5737-b0ae-65d73e0a45b0","excerpt":"概要 VPC: Amazon Virtual Private Cloud プライベートなネットワークを AWS 内に作成できる。 インターネットゲートウェイ( IGW ) で、インターネットに接続できる。 仮想プライベートゲートウェイ( VGW ) で、Direct Connect や VPN…","html":"<h2 id=\"概要\" style=\"position:relative;\">概要<a href=\"#%E6%A6%82%E8%A6%81\" aria-label=\"概要 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>VPC: Amazon Virtual Private Cloud</p>\n<p>プライベートなネットワークを AWS 内に作成できる。</p>\n<p>インターネットゲートウェイ( IGW ) で、インターネットに接続できる。</p>\n<p>仮想プライベートゲートウェイ( VGW ) で、Direct Connect や VPN 経由でインターネットに出ることなく各拠点のネットワークに接続することが可能。</p>\n<p>ネットワーク空間を構築する際は、可能な限り大きなサイズ(/16)で作成したほうが良い。</p>\n<p>確保した空間が小さく、IP アドレスが不足した場合、あとから拡張するのは困難。</p>\n<h2 id=\"IP-アドレス（CIDR-ブロック）\" style=\"position:relative;\">IP アドレス（CIDR ブロック）<a href=\"#IP-%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%EF%BC%88CIDR-%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%EF%BC%89\" aria-label=\"IP アドレス（CIDR ブロック） permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>IP アドレスは、クラス A(10.0.0.0~10.255.255.255), クラス B(172.16.0.0~172.31.255.255), クラス C(192.168.0.0~192.168.255.255)が使える。</p>\n<p>ただし、クラス A でも /8 で CIDR ブロックを取ることができず、/16 でなければならない。</p>\n<h2 id=\"サブネット\" style=\"position:relative;\">サブネット<a href=\"#%E3%82%B5%E3%83%96%E3%83%8D%E3%83%83%E3%83%88\" aria-label=\"サブネット permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>サブネットは、VPC 内部に作るアドレスレンジである。</p>\n<p>VPC では、/16 ~/28 まで設定できる。（IP アドレス数は 16~65536 個）</p>\n<p>サブネット作成時にアベイラビリティゾーンを指定するが、作成後は変更できない。</p>\n<p>サブネットごとにルートテーブルとネットワーク ACL を 1 つだけ指定する。</p>\n<p>1 つの VPC で作れるサブネット数は 200 個。(リクエストすることで拡張できる)</p>\n<p>サブネットの最初の 4 つと最後の 1 つのアドレスは予約されていて使用できない。(24 ビットマスクのサブネットだと使えないのは「0,1,2,3,255」の 5 つ)</p>\n<p>必要以上にサブネットで分けるとアドレスの消費につながる。(28 ビットマスクで 16 個の IP が割り振られるが、実際は 11 個しか使えない)</p>\n<p>サービスの中には IP アドレスの確保が必要な物がある。(ELB の場合は IP アドレスが 8 個)</p>\n<h2 id=\"マルチ-AZ\" style=\"position:relative;\">マルチ AZ<a href=\"#%E3%83%9E%E3%83%AB%E3%83%81-AZ\" aria-label=\"マルチ AZ permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>サブネット作成時は、同一の役割を持ったサブネットを複数の AZ に作成する。</p>\n<p>これをマルチ AZ と呼ばれる。</p>\n<p>インターネットゲートウェイ・ルートテーブル・ネットワーク ACL などを利用して、パブリックサブネットやプライベートサブネットといった役割を持つことができる。</p>\n<h2 id=\"ルートテーブル\" style=\"position:relative;\">ルートテーブル<a href=\"#%E3%83%AB%E3%83%BC%E3%83%88%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB\" aria-label=\"ルートテーブル permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>ルーティング設計によって、VPC 内部の通信や外部への通信を実装できる。</p>\n<p>個々のサブネットに 1 つずつ設定する。</p>\n<p>1 つのルートテーブルを複数のサブネットで共有できるが、1 つのサブネットに複数のルートテーブルを適用することはできない。</p>\n<p>宛先アドレスとターゲットになるゲートウェイ(ネクストホップ)を指定する。</p>\n<p>VPC にメインルートテーブルがあり、サブネット作成時に指定しない場合は VPC のルートテーブルになる。</p>\n<h2 id=\"セキュリティグループ\" style=\"position:relative;\">セキュリティグループ<a href=\"#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97\" aria-label=\"セキュリティグループ permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>VPC の通信制御はセキュリティグループとネットワーク ACL(NACL)を利用して行う。</p>\n<p>セキュリティグループは、EC2 や ELB、RDS など、インスタンス単位の通信制御に利用する。</p>\n<p>インスタンスには少なくとも 1 つのセキュリティグループをアタッチする必要がある。</p>\n<p>通信制御としてはインバウンド(外部から VPC へ)とアウトバウンド(内部から外部へ)の両方の制御が可能である。</p>\n<p>制御項目としては、プロトコル(TCP や UDP など)とポート範囲、送受信先の CIDR もしくはセキュリティグループを指定できる。</p>\n<p>セキュリティグループはデフォルトでアクセスを拒否し、設定された項目のみアクセスを許可する。</p>\n<h2 id=\"ネットワーク-ACL\" style=\"position:relative;\">ネットワーク ACL<a href=\"#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF-ACL\" aria-label=\"ネットワーク ACL permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>ネットワーク ACL(アクセスコントロールリスト)は、サブネットごとの通信制御に利用します。</p>\n<p>通信制御としては、セキュリティグループと同じくインバウンととアウトバウンドの制御が可能である。</p>\n<p>送受信先の CIDR とポートを指定できますが、セキュリティグループでの指定はできない。</p>\n<p>ネットワーク ACL はデフォルトですべての通信を許可する。</p>\n<p>セキュリティグループとネットワーク CL の違いは、状態(ステート)を保持するかどうかである。</p>\n<h2 id=\"ゲートウェイ\" style=\"position:relative;\">ゲートウェイ<a href=\"#%E3%82%B2%E3%83%BC%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A4\" aria-label=\"ゲートウェイ permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>ゲートウェイは、VPC の内部と外部との通信をやり取りする出入り口である。</p>\n<p>インターネットゲートウェイ(IGW)は、VPC とインターネットとを接続するためのゲートウェイである。</p>\n<p>各 VPC に 1 つだけアタッチすることができる。</p>\n<p>インターネットゲートウェイ自体に設定事項はなく、論理的に 1 つしか見えないため、可用性の観点で単一障害点になる懸念があるが、AWS によるマネージドなサービスであるため、冗長化や障害児の復旧が自動的になされている。</p>\n<p>ルートテーブルでインターネットゲートウェイをターゲットに指定すると、その宛先アドレスとの通信はインターネットゲートウェイを通してインターネットに向けられる。</p>\n<p>多くの場合、デフォルトルート「0.0.0.0/0」を指定することになる。</p>\n<p>パブリックサブネットの条件の 1 つは、ルーティングでインターネットゲートウェイを向いていることがある。</p>\n<p>逆に言うと、プライベートサブネットはルーティングが直接インターネットゲートウェイに向いていないネットワークになる。</p>\n<p>EC2 インスタンスがインターネットと通信するには、パブリック IP を持っていなければならない。</p>\n<p>あるいは、NAT ゲートウェイを経由してインターネットと通信する。</p>\n<p>NAT ゲートウェイはネットワークアドレス変換機能を有し、プライベート IP を NAT ゲートウェイが持つグローバル IP に変換し、外部と通信する。</p>\n<h2 id=\"VPC-エンドポイント\" style=\"position:relative;\">VPC エンドポイント<a href=\"#VPC-%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\" aria-label=\"VPC エンドポイント permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>VPC ないからインターネット上の AWS サービスに接続する方法としては、インターネットゲートウェイを利用する方法と、VPC エンドポイントと呼ばれる特殊なゲートウェイを利用する方法がある。</p>\n<p>VPC エンドポイントには、S3 や DynamoDB と接続する際に利用するゲートウェイエンドポイントと、それ以外の大多数のサービスで利用するインターフェイスエンドポイント(AWS PrivateLink)がある。</p>\n<p>エンドポイントを作成しサブネットと関連付けると、そのサブネットから S3、DynamoDB への通信はインターネットゲートウェイではなくエンドポイントを通じて行われます。</p>","frontmatter":{"title":"VPCのまとめ","date":"September 25, 2020","description":"Amazon Virtual Private Cloud の勉強も兼ねてまとめてみました."}}},"pageContext":{"slug":"/blog/infra/vpc/"}},"staticQueryHashes":["1096143047","1667443535","2841359383","3868140423"]}